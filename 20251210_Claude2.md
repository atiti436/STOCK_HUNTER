# Stock Hunter v4.4 交接報告

> 📅 日期: 2025-12-10
> 👫 參與者: 老婆 + 老公1號 (策略) + 老公2號 (執行)

---

## ✅ 今天做了什麼

### 1. 波段評分邏輯優化 (Phase 1)

| 改動 | 理由 |
|------|------|
| MA20 距離評分 (≤5% +3分, 5-10% +1分, >10% -1分) | 避免追高，靠近 MA20 才是好買點 |
| KD ≥80 扣分 | 高檔鈍化不宜追買 |
| 籌碼動態門檻 (依成交量分 500/2000/5000 張) | 小股票 +50 張有意義，大股票需要 +500 張 |
| 5日/10日漲幅過濾 (>10%/>15% 扣 2 分) | 已漲一段不要追 |
| PE 評分整合 | 基本面過濾 |
| 新聞情緒整合 | sentiment>0.3 加分 |
| 停損邏輯 `max(MA20, -7%)` | 停損不要離太遠 |

### 2. v4.4 升級

| 改動 | 理由 |
|------|------|
| 波段門檻 4→5 分 | 提高推薦品質 |
| ADMIN_USER_ID 環境變數 + Fallback | 老公1號建議，比較彈性 |
| 8:00 推播移除當沖 | 專心做波段，當沖另外觸發 |
| 新增「當沖」指令 | 管理員可手動查看當沖觀察名單 |
| `batch_gemini_analysis` 函數 | 準備批次呼叫，減少 API |
| `analyze_market_and_risk` 函數 | 市場趨勢 + 風險檢查 |
| TOP_N 從 15 → 8 | 減少 API 呼叫 |
| DAY_TRADE_MAX=3, SWING_TRADE_MAX=5 | 控制推薦數量 |

---

## ❌ 沒做什麼 (理由)

### 1. batch_gemini 尚未整合到 deep_analyze

**原本計畫**: 把 8 次 Gemini 呼叫合成 1 次

**沒做的理由**:
- `deep_analyze` 函數需要重構整體流程
- 當前是 for loop 內逐檔呼叫，改成批次需要改 2 段
- 改動量大，測試風險高
- 今天時間不夠，先確保基本功能穩定

**影響**:
- API 呼叫還是 8 次/天（不是預期的 2 次）
- 成本沒有降下來

**下一步**:
- 整合 `batch_gemini_analysis` 到 `deep_analyze`
- 整合 `analyze_market_and_risk` 到 `format_line_messages`

### 2. 個股分析 AI 報告升級

**沒做的理由**:
- 時間優先做 8:00 推播優化
- 個股分析目前還能用

---

## 📁 GitHub 狀態

**Repository**: https://github.com/atiti436/STOCK_HUNTER

**最新 Commit**: `v4.4: 主要升級 - 8:00 只推波段 + 當沖獨立指令 + 波段門檻提高`

---

## 🔧 需要繼續的工作

### Priority 1: 整合批次 Gemini (減少 API)

```python
# 目前 deep_analyze:
for candidate in to_analyze:
    # 每檔各呼叫 1 次 Gemini

# 改成:
all_data = [...]
batch_results = batch_gemini_analysis(all_data)  # 1 次
```

### Priority 2: 整合市場趨勢到推播

```python
# 在 format_line_messages 加入:
market_risk = analyze_market_and_risk(swing_trade_list, industry_trend)
msg1.append(f"🤖 {market_risk['market_summary']}")
msg1.append(f"⚠️ {market_risk['risk_warning']}")
```

### Priority 3: 回測驗證

- 用歷史資料測試新的評分邏輯
- 統計勝率、平均報酬

---

## 📊 關鍵檔案

| 檔案 | 路徑 |
|------|------|
| 主程式 | `c:\Users\atiti\OneDrive\桌面\領受奢\stock_hunter_v3.py` |
| Git 倉庫 | `c:\Users\atiti\OneDrive\桌面\領受奢\STOCK_HUNTER\` |

---

## 🎯 給下一個老公2號的提醒

1. **批次 Gemini 函數已經寫好**，在 `batch_gemini_analysis`（約 line 614-703）
2. **市場趨勢函數已經寫好**，在 `analyze_market_and_risk`（約 line 706-762）
3. **只需要整合到 `deep_analyze`**（約 line 1378-1475）
4. 整合後 **API 呼叫從 8 次變 2 次**
5. 記得更新推播格式加入 AI 市場分析

---

> 老公2號留
