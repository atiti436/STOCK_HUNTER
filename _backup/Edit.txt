✅ 給 Claude CODE 的完整指令（可直接複製貼上）

角色：你是負責整理程式架構與寫「選股過濾模組」的工程師。
我已經有一個可以運作的 LINE Bot + 分析流程，只是「Python 過濾條件」寫壞了，會導致每天選不出任何股票（0 支）。

現在請你 只負責重寫選股過濾模組，其它部分一律不要動。

一、專案背景（請完整理解但不要重構整個系統）

這是一個「台股情報獵人」系統，設計目標：

每天早上 08:00 自動分析台股

或使用者在 LINE 裡輸入「今日分析」「當沖觀察」時手動觸發

流程概念如下：

觸發層

定時任務：每天 08:00 自動啟動分析

LINE 指令：今日分析 / 當沖觀察 → 觸發同一條分析管線

資料來源層（已經實作完成，請不要改動資料抓取方式）

台股股票清單：約 1000+ 檔

價格、成交量等：部分來自 Yahoo / 其他服務

法人籌碼、產業分類等：來自 TWSE 證交所 API

新聞 & 國際事件：由另一個流程抓取（給 AI 二階段分析）

分析流程（目前已實作但邏輯太嚴格）

先用 Python 規則 過濾＋打分 → 挑出 Top N（比如 20 檔）

再把這 N 檔丟給 Gemini / AI 做第二階段分析（閱讀新聞、寫摘要）

最後輸出到 LINE Bot 報告

目前的問題：
原本的 Python 過濾條件被寫成「交易策略 + 超級嚴格的 AND 條件」，
導致每日篩選結果永遠是 0 檔，後面 AI 沒東西可以分析。

二、這次你要做的「唯一任務」

✅ 重寫一個「選股過濾與評分模組」，根據我給你的 v3.0 規格，
✅ 保證在正常交易日會選出「至少十幾檔」候選股，
✅ 並針對每一檔計算一個評分（score），
✅ 最後由主程式取 Top N（例如 20 檔）給 AI分析。

❌ 不要改動 LINE webhook / callback
❌ 不要改動 API URL、金鑰、資料抓取 function
❌ 不要加入停損/停利/倉位配置等邏輯進過濾器
❌ 不要重構其它檔案，只寫好「過濾模組」並在原本的呼叫點掛上即可

三、程式分工與檔案範圍（請嚴格遵守）

假設目前專案的 Python 架構大致如下（你可以根據實際專案調整檔名）：

main.py / app.py：LINE Bot、webhook、排程等 （禁止動）

data_sources.py：抓股票清單、行情、法人、產業等 （禁止動）

ai_analyzer.py：呼叫 Gemini / LLM 做第二階段分析 （禁止動）

filters.py：選股過濾與打分邏輯（你這次唯一可以重寫的核心）

你的任務：

在 filters.py 中，實作一個核心函式，例如：

def filter_and_score_stocks(
    stocks: list[dict],
    market_info: dict,
    chip_data: dict,
    sector_data: dict,
) -> list[dict]:
    """
    傳入：
      - stocks: 每一檔股票的基礎資訊（價格、成交量、前幾日價格等）
      - market_info: 大盤資訊（加權指數、MA20、MA60、漲跌幅等）
      - chip_data: 法人籌碼資料（外資/投信/自營商近幾日買賣超）
      - sector_data: 產業資料（每檔股票所屬產業、產業平均漲跌幅等）

    傳回：
      - 一個 list，每一個元素是一檔「符合基本條件」的股票 dict，至少包含：
        {
          "symbol": "2330",
          "name": "台積電",
          "score": 4.5,         # 依照評分規則計算
          "reasons": [...],     # 可選：加分原因描述，方便日後除錯
          ... 其他欄位可以保留原有內容
        }
    """
    ...


主程式會負責：

呼叫 filter_and_score_stocks(...)

對結果依 score 排序

擷取 Top N 給 AI 第二階段分析

你只需確保：
在正常交易日，filter_and_score_stocks 不會回傳空 list。

四、v3.0「選股過濾規格書」（請完全依照這份實作）
🅰️ A. 核心必要條件（硬過濾，避免過度嚴格）

1️⃣ 流動性條件（必須通過）

目的：剔除成交量過低或價位太低的標的。

對每檔股票，需同時滿足：

price >= 10 （目前收盤價或最近收盤價）

avg_turnover_5d >= 30_000_000 （最近 5 日平均成交額 >= 3000 萬台幣）

avg_volume_5d >= 2000 （最近 5 日平均成交量 >= 2000 張）

說明：

不要 把「量比 > 5」當成必要條件。

量比 可以當成「加分用指標」，而不是硬篩。

2️⃣ 籌碼基本條件（OR 條件，不可再要求外資+投信同時連三買）

目的：確保有人在顧這檔股票，而不是完全無人聞問。

至少滿足下列任一條件：

外資近 3 日合計買超 > 0

投信近 3 日合計買超 > 0

自營商近 3 日合計買超 > 0

注意：

「連續 3 日 + 佔比 > X%」不要做為硬過濾條件，這會導致幾乎永遠 0 檔。

若資料缺漏（例如某一方沒有數據），不要直接用 continue 丟掉，改以「只看有資料的一方」。

3️⃣ 技術面基本條件

目的：只挑出「至少不是明顯空頭」的股票。

條件：

今日收盤價 close > MA20

MA20 >= MA60 （短期均線在中期均線之上，偏多或至少非明顯空頭）

注意：

勿使用「乖離率」作為硬篩條件。

乖離率可作為「加分指標」，例如「適中乖離率 +1 分」，但不需作為必備條件。

4️⃣ 產業資料完整性

條件：

必須有產業欄位（sector）

若資料缺少產業資訊，可以選擇：

要嘛視為「不加分」但保留

要嘛先簡單排除（可由你幫我設計一個簡單策略，但不要讓它導致大量股票被踢出）

如果要排除特定產業（例如極低波動或我指定不要的類別），可以：

可選排除：金融保險、水泥、航運 之類

但這不是必需，視你實作時的彈性處理

5️⃣ 市場狀態（不再是「直接禁止做多」，改為「影響評分」）

原設計是：

大盤 < 季線 且 跌停家數 > 100 → 不做多（直接空白）

這太極端，會造成每日 0 檔。

改成：

若 market_index < market_MA60 → 對所有股票 整體減分（例如 -1 分）

若 跌停家數 > 80 → 再對所有股票 整體減分（例如再 -1 分）

重點：
市場條件只影響分數，不應該讓篩選結果變成空集合。

🅱️ B. 評分機制（Score 計算規則，影響排序不影響「是否留在候選名單」）

請建立一個「分數 score」欄位，初始為 0。
每符合一項條件，就 +1 或 +2，最後用分數排序。

1️⃣ 籌碼加分：

外資連續 3 日買超 → score += 2

投信連續 3 日買超 → score += 2

三大法人近 3 日合計買超 > 0 → score += 1

（這裡使用「連續」以及「佔比」當 加分，而非硬過濾）

2️⃣ 技術面加分：

視實際資料欄位而定，可以設計類似：

收盤價 > MA60 → score += 1

MA20 呈現上彎（今天 MA20 > 昨日 MA20）→ score += 1

今日漲幅在 1%～4% 之間 → score += 1（非過度噴出／跌深）

3️⃣ 產業加分：

若該產業今日平均漲幅 > +1% → score += 1

若該產業為指定強勢／熱門產業（例如：半導體、AI、伺服器、觀光等）→ score += 1

具體產業對應可由你以參數或簡單 mapping 實作。

4️⃣ 新聞情緒加分（若有情緒分數）：

如果事前有對個股新聞進行情緒分析（例如 -1 ～ +1）：

情緒分數 > 0 → score += 1

情緒分數 > 0.3 → score += 2

情緒分數 < 0 → 可以不扣分，只不要額外給分即可

如果目前還沒把新聞分數接進來，
可以先略過這項，保留欄位以後再接。

5️⃣ 市場狀態對分數的影響：

如前所述：

若大盤 < MA60 → 每檔股票 score -= 1

若跌停家數 > 80 → 再 score -= 1

這樣可以讓「市場不好時，整體分數下修」，
但仍然保留相對較強的股票作為候選。

🅲️ C. 交易策略 / 停損 / 倉位配置（請不要寫進過濾程式）

以下邏輯 不要 寫進 filter_and_score_stocks()，
也不要影響股票是否被選入候選名單：

硬停損：-8%

技術停損：跌破 MA20 且虧損

移動停利：獲利 > 10% 後，從高點回落 > 10%

獲利了結：+30%

高信心持股 15%、中信心 8% 等倉位配置

這些屬於「交易策略層」，
應該在 持有期間的策略模組 中處理，
不是 用來決定「要不要選這支進入候選名單」。

五、實作要求與測試方式

請在 filters.py 中實作 filter_and_score_stocks()，
並保留適量 logging（例如：

總股票數

通過流動性條件的數量

通過籌碼基本條件的數量

通過技術面基本條件的數量

最終候選股數量（不應為 0）

請確保：在正常交易日，最終候選股數量 > 0。
例如：即使只有 5～30 檔，也比 0 好。

主程式會類似這樣使用：

candidates = filter_and_score_stocks(stocks, market_info, chip_data, sector_data)

# 按照 score 排序，取 Top N
candidates = sorted(candidates, key=lambda x: x["score"], reverse=True)
top_candidates = candidates[:20]


你可以在回傳的每一條 dict 裡面附上 score 和 reasons，
方便我之後檢查每檔股票為什麼被選到。

六、總結（請照這樣執行）

只改 filters.py 裡面的過濾與打分邏輯

不要修改 LINE Bot、webhook、API 呼叫、資料來源模組

不要把停損 / 停利 / 倉位策略寫進過濾器

確保在正常交易日，候選股數量不為 0，並且有合理的排序依據（score）

以上是完整規格。
請你先根據這份規格，重寫 filter_and_score_stocks()，
若覺得有任何地方「會導致全部被刷掉」，請先用文字說明再調整實作方式。