# 選股 BOT v4.1 使用說明

---

## 🎯 **當前狀態（2026-01-02 21:30）**

| 檔案 | 版本 | 狀態 | 說明 |
|------|------|------|------|
| `scan_v3.py` | v3.4.1 | ✅ 穩定 | 多 TOKEN 輪替（1800次/小時） |
| `scan_v4.py` | **v4.1** | ✅ **完成** | **FinMind 優先 - 17:30 有資料** |

### v4.1 重大變更 🔥

**問題**：20:30 執行時，證交所 STOCK_DAY_ALL 還沒更新當天資料
**解法**：改用 **FinMind 全市場查詢**，17:30 就有今天收盤價 ✅

| 資料來源 | 更新時間 | 20:30 有今日資料？ |
|---------|---------|------------------|
| ~~證交所 STOCK_DAY_ALL~~ | ~22:00 | ❌ 20:30 還是舊的 |
| **FinMind 全市場** | **17:30** | ✅ **一定有** |

---

## 功能

找「法人有在買、趨勢向上、還沒過熱」的股票

### v4.1 新增

- 🔥 **FinMind 優先** - 當日股價改用 FinMind 全市場查詢（17:30 有資料）
- 🛡️ **Fallback 機制** - FinMind 失敗自動切換證交所 API
- ✅ **保留所有 v4.0 功能** - 計分制、分批停利、門神不變

### v4.0 功能（保留）

- ✅ **計分制** - 依籌碼/動能/安全評分（最高 7 分）
- ✅ **分批停利** - +4% / +7% / +10% 三批出場
- ✅ **門神加強** - 營業利益率 ≥ 3%、毛利率 ≥ 15%
- ✅ **數量控制** - 每日最多 6 檔（score ≥ 3）
- ✅ **分級圖示** - 🔥≥7 / ✅≥5 / 👀≥3

---

## 篩選條件

**基本面**
- 價格 30-300 元
- PE < 35
- 營收 YoY > 0%
- 營業利益率 ≥ 3%
- 毛利率 ≥ 15%

**技術面**
- 今日漲幅 -2% ~ 5%
- 近 5 日漲幅 < 10%
- 今日量 > 5 日均量
- 股價 > MA20
- RSI < 80

**籌碼面**
- 法人連續買超 ≥ 2 天
- 法人 5 日累積 > 300 張
- 日成交量 > 800 張
- 法人 1 月累積 > -10,000 張

---

## 使用方式

```bash
cd STOCK_HUNTER
python scan_v4.py  # v4.1 FinMind 優先版
python scan_v3.py  # v3.4 基礎版
```

輸出到 `scan_result_v4.txt` 或 `scan_result_v3.txt`

---

## 🏗️ 系統架構

```
每天 20:30 (週一~週五)
┌──────────────────┐
│  GitHub Actions  │  ← 跑 scan_v4.py (v4.1)
└────────┬─────────┘
         ↓ push_to_linebot.py
┌──────────────────┐
│  Zeabur (精簡版)  │  ← 只當轉發站
└────────┬─────────┘
         ↓ LINE Messaging API
┌──────────────────┐
│   LINE 通知你    │
└──────────────────┘
```

---

## 📡 API 使用（v4.1 更新）

| API | 用途 | 更新時間 | 限制 |
|-----|------|----------|------|
| **FinMind 全市場** | **當日股價**（優先） | **17:30** ✅ | 1 次呼叫/天 |
| **證交所 STOCK_DAY_ALL** | 當日股價（Fallback） | ~22:00 | 免費無限 |
| **證交所 BWIBBU_ALL** | PE 本益比 | 即時 | 免費無限 |
| **FinMind 逐檔** | 法人、歷史股價、營收 | 每日更新 | 600/hr × 3 = 1800/hr |

### v4.1 資料流

```
[1] 當日股價
    FinMind 全市場 (17:30 有資料) ✅
    ↓ 失敗？
    證交所 STOCK_DAY_ALL (Fallback)

[2] PE 本益比
    證交所 BWIBBU_ALL

[3] 法人買賣超
    FinMind 逐檔查詢（3 TOKEN 輪替）

[4] 歷史股價、營收
    FinMind 逐檔查詢
```

---

## ⚠️ Zeabur 部署注意

已設定 `.dockerignore`，Push 只會部署必要檔案：
- `line_relay.py`、`requirements.txt`、`Dockerfile`、`Procfile`

不會觸發部署：
- `scan_v3.py`、`scan_v4.py`、`README_v3.md`、`data/*`

---

## 評分標準（v4.0/v4.1）

| 類別 | 條件 | 分數 |
|------|------|------|
| **籌碼** | 法人買 1-3 天 | +3 |
| | 法人買 4-5 天 | +2 |
| | 法人買 ≥6 天 | +1 |
| | 5日買超 > 1000 張 | +1 |
| **動能** | 量 > 1.5 倍均量 | +1 |
| | 漲幅 0-4% | +1 |
| **安全** | 乖離 < 8% | +1 |

**評級**：🔥 ≥7 / ✅ ≥5 / 👀 ≥3

---

## 版本紀錄

| 版本 | 日期 | 重點 |
|------|------|------|
| **v4.1** | **2026-01-02** | **FinMind 優先 - 當日股價 17:30 有資料** |
| v4.0 | 2026-01-02 | 計分制 + 分批停利 + 門神加強 |
| v3.4.1 | 2026-01-01 | 多 TOKEN 輪替（1800次/小時） |
| v3.4 | 2026-01-01 | 劇本小卡（停損/停利） |
| v3.3 | 2026-01-01 | RSI 過熱判斷 |
| v3.2 | 2026-01-01 | 健康檢查 + API 警告 |

---

## 🚀 v4.2 展望

### 犀利媽 RSI 雙線戰法

> 目前 v4.1 只用 RSI14 < 80，未來可升級成雙線判斷

```python
rsi_short = rsi_5   # 5日線 (極短線)
rsi_long = rsi_10   # 10日線 (波段線)

# 1. 絕對禁區：RSI10 > 80 直接淘汰
if rsi_long > 80:
    return False  # 不准選

# 2. 黃金買點：兩線在 50-75，且短線 > 長線
elif 50 <= rsi_long <= 75 and rsi_short > rsi_long:
    score += 2  # RSI 多頭排列

# 3. 超跌區：RSI5 < 20 可搶反彈
elif rsi_short < 20:
    score += 1
```

**待實作**：需要先計算 RSI5 和 RSI10（目前只有 RSI14）

---

## 📈 開發進度（8 大模組）

| Epic | 模組名稱 | 狀態 | 說明 |
|------|----------|------|------|
| 1 | 資料基礎設施 | ✅ 完成 | FinMind + 證交所 OpenAPI |
| 2 | 核心計算引擎 | ✅ 完成 | MA、RSI、成交量 |
| 3 | 大盤濾網 | ⚠️ 50% | v3 有 TAIEX MA20，v4 待加 |
| 4 | 自動策略 | ✅ 完成 | 門神 + 計分制 |
| 5 | 評分系統 | ✅ 完成 | 7 分制（籌碼/動能/安全）|
| 6 | 智能輸出 | ✅ 完成 | LINE 推播 + 劇本小卡 |
| 7 | 回測驗證 | 🔄 進行中 | backtest_v4.py |
| 8 | 全自動化 | ⚠️ 70% | GitHub Actions 已跑，差自動下單 |

---

## 🧪 v4.2 回測計畫

**目標**：驗證 v4.0 策略在 2024 年的表現

### 回測設計

```
輸入：2024-01-01 ~ 2024-12-31
↓
每個交易日跑 v4.0 選股邏輯
↓
紀錄推薦股票
↓
追蹤 5 日 / 10 日後漲跌
↓
計算勝率 + 平均報酬
```

### 預期產出

```
📊 v4.0 策略回測報告（2024 年）
- 總推薦次數：xxx 次
- 勝率（5日後漲）：xx%
- 平均報酬：+x.x%
- 最大虧損案例：xxx
- 最大獲利案例：xxx
```

### 檔案

- `backtest_v4.py` - 回測腳本
- `backtest_result.json` - 回測結果

---

## 🔧 v4.1 技術細節

### 為什麼改用 FinMind？

**問題診斷**：
```
2026-01-02 20:45 執行結果：
- 技嘉 249.5 元（實際收盤 259.0）❌
- 緯創 150.5 元（實際收盤 155.0）❌

原因：證交所 STOCK_DAY_ALL 在 20:30~21:30 還是前一天的資料
```

**解決方案**：
```python
# v4.1 改用 FinMind 全市場查詢
df = dl.taiwan_stock_daily(
    start_date=today,
    end_date=today
    # 不指定 stock_id → 拿全市場
)
# 17:30 就有今天資料 ✅
```

**Fallback 機制**：
```python
try:
    # 優先用 FinMind
    df = dl.taiwan_stock_daily(...)
except:
    # 失敗改用證交所
    url = 'https://openapi.twse.com.tw/...'
```

---

## 🐛 2026-01-02 偵錯紀錄（待明日確認）

> 今天鬼打牆，紀錄問題給明天的 AI 繼續

### ❌ 已修正的 Bug

| Bug | 原因 | 修正 |
|-----|------|------|
| 股價錯誤（150.5 vs 155） | 證交所 `STOCK_DAY_ALL` 延遲 | 改用 FinMind 全市場 |
| FinMind volume = 0 | 欄位名錯誤 `Trading_Volume` | 改成 `Trading_turnover` |
| LINE 只顯示數量 | `push_to_linebot.py` 讀 v3 | 改成優先讀 v4 |
| history JSON 不 commit | workflow 設定問題 | 加了 `.gitignore` 例外 |

### ⚠️ 待確認事項（明天跑完確認）

1. **FinMind 全市場能正常抓資料嗎？**
   - 今天 Token 用完無法測試
   - 明天 20:30 Actions 跑完看 history/2026-01-03.json

2. **收盤價是否正確？**
   - 應該是 155 / 259（緯創/技嘉）
   - 不應該是 150.5 / 249.5

3. **LINE 推送有劇本小卡嗎？**
   - `push_to_linebot.py` 已改成讀 v4
   - 看 LINE 訊息有沒有完整股票資訊

4. **scan_result_v4.txt 有 commit 嗎？**
   - workflow 已加進去
   - 明天 git pull 確認

### 🔥 Token 使用警告

今天回測用太多次，3 個 TOKEN 全部爆掉：
- 回測用了幾千次（抓歷史資料）
- scan_v4.py 後來重試 254 次都失敗

**建議**：回測時用證交所 API（無限制），日常選股用 FinMind

### 📋 明天驗證 Checklist

- [ ] 20:30 Actions 自動跑成功
- [ ] LINE 收到完整推薦（有股票名稱 + 劇本小卡）
- [ ] git pull 能拿到 scan_result_v4.txt
- [ ] 收盤價正確（不是舊資料）
- [ ] history/2026-01-03.json 有正確資料

