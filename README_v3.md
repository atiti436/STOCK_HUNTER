# 選股 BOT v3.4 使用說明

---

## 🎯 **當前狀態（2026-01-02 02:51）- 下個 Claude 從這裡看起**

### 📌 現有版本

| 檔案 | 版本 | 狀態 | 說明 |
|------|------|------|------|
| `scan_v3.py` | v3.4.1 | ✅ 穩定 | 多 TOKEN 輪替（1800次/小時） |
| `scan_v4.py` | v4.0 Phase 1 | ✅ 測試通過 | 計分制 + 分批停利 |

### ✅ Phase 1 已完成（2026-01-02 凌晨）

- [x] 計分函數（`calculate_v4_score`）
- [x] 分批停利函數（`calculate_batch_profit`）
- [x] 結果加入 `score`, `reasons`, `batch_profit` 欄位
- [x] 輸出顯示分數、理由、分批停利

**測試結果**：技嘉 6 分，顯示正常 ✅

### ⏳ Phase 2 待辦（下個 Claude 要做）

**目標**：完整 Gemini 融合版

1. **門神加強**（L960-970）
   ```python
   # 找 operating_margin 檢查
   if operating_margin < 3:  # 改成 3
   if gross_margin < 15:     # 改成 15
   ```

2. **推薦數量控制**（L1025）
   ```python
   # 排序後過濾
   results = sorted(results, key='score', reverse=True)
   results = [r for r in results if r['score'] >= 3][:6]
   ```

3. **輸出優化**（L1088-1125）
   - 依分數分級：🔥≥7 / ✅≥5 / 👀≥3
   - 突出顯示高分股

4. **測試驗證**
   ```bash
   python scan_v4.py
   # 應該找到 3-6 檔，緯創和技嘉都要有
   ```

### 🐛 已知問題

1. **緯創被過濾** - 因營收 API 失敗（TOKEN 用完）
   - 解決：等 TOKEN 重置或加容錯（見 L320）
2. **營收成功率 3%** - FinMind TOKEN 達上限
   - 解決：凌晨 01:00 重置後恢復

---

### ⚠️ **Zeabur 部署注意事項（重要！）**

**問題**：Push 會觸發 Zeabur 自動部署，如果 Docker Image 太大會等 10+ 分鐘

**解決**：已加入 `.dockerignore` 排除不必要檔案 ✅

#### 🚫 不要 Push 這些檔案（會拖慢部署）
- `scan_v3.py`、`scan_v4.py` - Zeabur 不需要
- `data/*`、`_backup/*` - 資料檔案
- `*.md`（除了 README） - 文檔

#### ✅ 只 Push 必要檔案
- `line_relay.py` - Zeabur 主程式
- `requirements.txt` - 依賴清單
- `Dockerfile`、`Procfile` - 部署設定
- `.dockerignore` - **必須保留！**

#### 📝 下次改動前檢查
```bash
# 檢查會被複製進 Docker 的檔案
git diff --name-only

# 如果只改 scan_v3/v4、README → 可以放心 push（不影響 Zeabur）
# 如果改 line_relay.py、requirements.txt → 會觸發部署（約 2-3 分鐘）
```

**教訓**：2026-01-02 凌晨沒加 `.dockerignore` 前，部署等了 10+ 分鐘 😭

---

## 🔄 **v3.4.1 更新 (2026-01-01 22:30)**

### ✅ 已完成：多 TOKEN 輪替功能（真正實作版）

**問題：** 上一版只定義了輪替函數，但沒真的用，導致 600 次用完就掛了

**解決：** 已完整實作 API 失敗時自動切換 TOKEN 重試機制

#### 📝 改動內容

1. **新增第 3 個 TOKEN**
   ```python
   FINMIND_TOKENS = [
       'token1 (atiti)',
       'token2 (atiti436)',
       'token3 (xiai)',  # ← 新增
   ]
   ```

2. **所有 FinMind API 呼叫改用函數**
   - `FINMIND_TOKEN` → `get_finmind_token()`
   - 修改位置：
     - `fetch_historical_prices()` - L154
     - `fetch_institutional_history_for_stocks()` - L211
     - `fetch_financial_data()` - L316
     - `fetch_revenue_data()` - L460

3. **加入自動重試邏輯**
   - API 失敗 → 自動 `rotate_token()` → 換下個 TOKEN 重試
   - 最多重試 3 次（3 個 TOKEN 都試過）
   - 每次重試都會顯示 `[TOKEN] 切換到 Token #N`

4. **修復 Windows emoji 問題**
   - `🔄 切換...` → `[TOKEN] 切換...`（避免 cp950 編碼錯誤）

#### 🧪 測試結果

**狀態：功能正常 ✅**
- TOKEN 輪替機制運作正常
- 每檔股票都自動重試 3 次（log 可見每個 data_id 出現 3 次）
- 但因為 **3 個 TOKEN 今天都達上限 600 次**，導致：
  - 每檔都要重試 3 次才放棄
  - 127 檔 × 3 次 = 381 次呼叫（只算法人資料）
  - 執行時間 > 5 分鐘（正常應該 < 2 分鐘）

#### ⏰ 建議

**明天凌晨 TOKEN 重置後再測試，屆時速度會恢復正常**

目前 TOKEN 狀態（2026-01-01 22:30）：
- Token #1 (atiti): ❌ 已達上限
- Token #2 (atiti436): ❌ 已達上限
- Token #3 (xiai): ❌ 已達上限
- 重置時間：約 2.5 小時後（2026-01-02 01:00）

#### 📊 預期效果（TOKEN 恢復後）

- **單 TOKEN 夠用時**：直接跑完，速度快
- **單 TOKEN 不夠時**：自動切換第 2、3 個，600×3 = 1800 次/小時
- **都不夠時**：顯示重試訊息，gracefully fail

---

## 功能

找「法人有在買、趨勢向上、還沒過熱」的股票（狼性操盤手版）

## 篩選條件

**基本面**
- 價格 30-300 元
- PE < 35
- 營收 YoY > 0%

**技術面**
- 今日漲幅 -2% ~ 5% (v3.3: 容許小回檔)
- 近 5 日累積漲幅 < 10%
- 今日量 > 5 日均量
- 股價 > MA
- **RSI < 80 (v3.3 新增: 避免過熱)**

**籌碼面**
- 法人連續買超 >= 2 天 (v3.3: 移除上限)
- 法人 5 日累積 > 300 張
- 日成交量 > 800 張
- 法人 1 月累積 > -10,000 張
- 主力分析 (投信/外資/混合)

## 使用方式

```bash
cd STOCK_HUNTER
python scan_v3.py
```

執行後會產生 `scan_result_v3.txt`，包含健康檢查報告和推薦股票。

## ⚠️ 防呆機制 (v3.2 新增)

### 健康檢查報告

輸出檔案會包含資料健康狀態：

```
[健康檢查]
✅ 資料正常
  證交所: 91 檔
  PE: 807 檔
  法人: 30/30 成功
  營收: 28/30 成功
```

### API 異常警告

當 API 有問題時會顯示警告：

| 異常類型 | 警告訊息 |
|---------|---------|
| API 完全失敗 | `API錯誤: xxx` |
| 達到 FinMind 上限 | `法人資料大量失敗 (xx%)，FinMind 可能達上限` |
| 資料被截斷 | `證交所 API 無資料（可能被擋或假日）` |
| 成功率過低 | `法人資料成功率過低 (xx%)` |

### LINE 訊息範例（有異常時）

```
📊 選股 BOT v3.2 - 2026-01-01

⚠️ 資料警告: 法人資料大量失敗 (45%)，FinMind 可能達上限

❌ 今日無符合條件的股票
```

## 環境設定

### FinMind API Token

程式已內建 Token（600 次/小時），也可透過環境變數覆蓋：

```bash
export FINMIND_TOKEN="your_token_here"
```

---

## 🏗️ 系統架構 (2026-01-01 更新)

```
每天 20:30 (週一~週五)
┌──────────────────┐
│  GitHub Actions  │  ← 跑 scan_v3.py
└────────┬─────────┘
         ↓ push_to_linebot.py
┌──────────────────┐
│  Zeabur (精簡版)  │  ← 只當轉發站，不做運算
└────────┬─────────┘
         ↓ LINE Messaging API
┌──────────────────┐
│   LINE 通知你    │
└──────────────────┘
```

### 各元件職責

| 元件 | 檔案 | 職責 |
|------|------|------|
| **GitHub Actions** | `scan_v3.py` | 每日 20:30 掃描選股 |
| **Zeabur** | `line_relay.py` (精簡版) | 接收推送 → 轉發 LINE |
| **本地** | 問 Claude | 隨時分析單股 |

### 為什麼這樣設計？

1. **GitHub Actions 免費** — 不用擔心運算額度
2. **Zeabur 精簡** — 只保留 Flask + LINE SDK，映像變小
3. **不需要即時互動** — 每日推送夠用，急需分析問 Claude

## 📡 API 使用狀態

### 目前使用

| API | 用途 | 限制 | 狀態 |
|-----|------|------|------|
| **證交所 OpenAPI** | 當日股價、PE | 免費無限制 | ✅ 穩定 |
| **FinMind 免費會員** | 法人、歷史股價、營收 | 600 次/小時 | ⚠️ 觀察中 |

### 後續考慮方案

| 方案 | 優點 | 缺點 | 備註 |
|------|------|------|------|
| **Shioaji** (永豐金證券) | 免費、即時報價 | 需開戶 | Python API |
| **FinMind 付費版** | 穩定、資料完整 | $1499/月 | 目前觀察免費版穩定度 |
| **Fugle 富果** | 即時行情 | 需註冊、限制較多 | 備選 |

### 穩定度觀察紀錄

| 日期 | 狀況 | 結論 |
|------|------|------|
| 2026-01-01 | 免費會員 600 次/小時，測試正常 | ✅ |
| 2025-12-31 | 疑似 API 塞車（實為買超天數邏輯問題） | ✅ 非 API 問題 |

---

## 版本紀錄

### v3.4.1 (2026-01-01 22:30) 🔥 重要更新
- **修復**: 多 TOKEN 輪替功能完整實作（v3.2 只有定義沒有使用）
- **新增**: 3 個 FinMind TOKEN 自動輪替（atiti, atiti436, xiai）
- **新增**: API 失敗時自動切換 TOKEN 重試機制（最多 3 次）
- **新增**: 顯示 TOKEN 切換訊息 `[TOKEN] 切換到 Token #N`
- **修復**: Windows emoji 編碼錯誤（🔄 → [TOKEN]）
- **改進**: 所有 FinMind API 函數加入重試邏輯
  - `fetch_historical_prices()`
  - `fetch_institutional_history_for_stocks()`
  - `fetch_financial_data()`
  - `fetch_revenue_data()`
- **效果**: 單小時 API 上限從 600 次提升到 1800 次（3 個 TOKEN）

### v3.4 (2026-01-01)
- **新增**: 劇本小卡功能 - 每檔推薦股票附帶停損/停利價格
- **新增**: 動態停損邏輯 (乖離>5%守MA10，乖離<5%守MA20，底線-7%)
- **新增**: 停利目標 +20%
- **新增**: LINE 訊息改用卡片式格式

### v3.3 (2026-01-01)
- **新增**: RSI < 80 過熱判斷（避免追在最高點）
- **放寬**: 漲跌幅 -2% ~ 5%（原 0-5%，容許小回檔）
- **放寬**: 法人連續買超 >= 2 天（移除上限 7 天）
- **修正**: 編創 (3231) 回歸名單（原被 8 天上限刷掉）

### v3.2 (2026-01-01)
- **新增**: FinMind API Token 支援（600 次/小時）
- **新增**: 健康檢查報告（證交所/PE/法人/營收 成功率）
- **新增**: API 錯誤偵測與警告（達上限、被擋、無資料）
- **新增**: LINE 訊息顯示資料警告
- **新增**: 股價 > MA20 趨勢確認
- **新增**: 法人 5 日累積 > 300 張
- **新增**: 日成交量 > 800 張
- **放寬**: 價格 30-300 元（原 50-200）
- **放寬**: PE < 35（原 < 25）
- **放寬**: 營收 YoY > 0%（原 > 10%）
- **放寬**: 法人買超 2-7 天（原 3-5 天）

### v3.1 (2025-12-31)
- 新增: 營收 YoY > 10% 檢查
- 新增: 法人 1 月累積 > -10,000 張檢查
- 新增: 主力分析功能
- 移除: 寬鬆版輸出
- 暫停: 財報檢查

### v3.0 (2025-12-31)
- 新增：近 5 日漲幅檢查
- 新增：法人買超天數檢查
- 新增：成交量突破檢查

---

## 🚀 v4.0 改版計畫（分階段實作）

> **更新時間**：2026-01-02 02:40  
> **決策**：採用分階段推進，避免趕工出錯  
> **狀態**：Phase 1 進行中

---

### 📋 實作策略

經過 Claude + Gemini + 用戶三方討論，決定採用 **分階段實作**：

| 階段 | 內容 | 預估時間 | 狀態 |
|------|------|---------|------|
| **Phase 1** | 簡化版 v4.0 | 30 分鐘 | 🔄 進行中 |
| **Phase 2** | 完整版 v4.0 | 1 小時 | ⏳ 待辦 |

---

### ✅ Phase 1：簡化版 v4.0（2026-01-02 凌晨）

**目標**：加入計分制和分批停利，但保留 v3.4 門神

#### 已完成
- [x] `calculate_v4_score()` 函數（Gemini 融合版）
- [x] `calculate_batch_profit()` 函數

#### 進行中
- [ ] 在 final_filter 中呼叫計分函數
- [ ] 結果加入 `score` 和 `reasons` 欄位
- [ ] 輸出顯示分數和評分理由
- [ ] 輸出顯示分批停利（+4%/+7%/+10%）

#### 不改（保留 v3.4）
- ❌ 門神邏輯（營業利益率仍用 v3.4 邏輯）
- ❌ Top 3-6 限制（全部輸出）
- ❌ RSI 雙線（仍用 RSI14 < 80）

**風險**：低（只加欄位，不改核心邏輯）

---

### ⏳ Phase 2：完整版 v4.0（待下個 Claude）

**目標**：實作完整的 Gemini 融合版邏輯

#### 待實作項目

1. **門神加強**（約 20 行）
   ```python
   # 現在 v3.4
   if operating_margin < 0:  # 只檢查是否虧損
       continue
   
   # 改成 v4.0
   if operating_margin < 3:  # 至少賺 3%
       continue
   if gross_margin < 15:  # 毛利率至少 15%
       continue
   ```

2. **推薦數量控制**（約 30 行）
   ```python
   # 依分數排序
   results = sorted(results, key=lambda x: x['score'], reverse=True)
   
   # 只推 Top 3-6（≥ 3 分）
   final_results = [r for r in results if r['score'] >= 3][:6]
   ```

3. **輸出優化**（約 50 行）
   - 依分數分級：🔥 ≥7分 / ✅ ≥5分 / 👀 ≥3分
   - 每檔顯示評分理由
   - 突出顯示分批停利策略

4. **測試驗證**
   - 用緯創和技嘉驗證評分正確
   - 確認分批停利計算正確
   - 健康檢查正常運作

---

### 📝 給下個 Claude 的提示

**Phase 2 實作重點**：

1. **找到 final_filter 的門神區域**（約 L860-L870）
   - 搜尋 `operating_margin`
   - 改成 `> 3` 和 `< 15`

2. **找到結果排序區域**（約 L900-L910）
   - 加入分數排序
   - 過濾 `score >= 3`
   - 限制 `[:6]`

3. **找到 output_results 函數**（約 L1000-L1050）
   - 加入分數分級邏輯
   - 優化劇本小卡顯示
   - 加入評分理由

4. **測試指令**
   ```bash
   python scan_v4.py
   # 檢查 scan_result_v4.txt 格式是否正確
   ```

---

### 🎯 Phase 1 預期成果

**輸出範例**（scan_result_v4.txt）：

```
🎯 緯創 (3231) $150.5 (+2.4%) - 6 分
   評分理由：法人買超 | 力道強(43K張) | 量增 | 位階安全
   
   【分批停利】
   第 1 批：$156.5 (+4% 保本先跑)
   第 2 批：$161.0 (+7% 主要目標)
   第 3 批：$165.6 (+10% 賺更多)
   
   🛡️ 停損: $144.8 (-3.8%) - 守MA20
   📊 主力: 外資 | 法人5日: +43,470張
```

---

### 🏆 完整版 v4.0 目標（Phase 2）

最終達成：
- ✅ 門神過濾垃圾股（營業利益率 > 3%）
- ✅ 計分制精準推薦（Top 3-6）
- ✅ 分批停利避免「200 一瞬間」
- ✅ 評分理由清楚透明

---

## 📋 背景與需求

#### 用戶真實經驗
```
南亞科案例：
- 160 當沖賠 → 放著
- BOT 天天跳提醒 → 187.5 再買
- 200 一瞬間（來不及賣）
- 跌到 189.5 → 190 停損出場
- 收盤 193-194（後悔沒賣 200）

教訓：
1. 移動停利需要盯盤（不實際）
2. 200 只有一瞬間（上廁所就錯過）
3. 人性會猶豫（想了一下才按）
4. 需要「分批停利」避免全有全無
```

#### 用戶操作習慣
- **時間軸**：20:30 BOT 推薦 → 晚上驗證（找 AI、查新聞）→ 隔天早上（有時睡到 10 點）
- **盯盤狀況**：在家，但不能時時盯盤（上廁所喝水就翻黑）
- **操作方式**：人工按單（非自動交易）
- **推薦數量**：3-6 檔（不要太多）
- **股價舒適區**：**100-300 元**（原 100-200 放寬）

#### 當前持倉計畫
```
總資金：100 萬

技嘉 (2376) - 長線佈局
  現價：249 元
  策略：等回檔 245 買 1-2 張
  理由：長線放久，不急

緯創 (3231) - 短線波段（3-10天）
  現價：151 元
  策略：明天開盤先買 1 張試水溫
  理由：CES 題材、川普/中國隨時放屁，快進快出

資金配置建議：
  保守：技嘉 1 張 + 緯創 1 張 = 40 萬（60 萬備用）
  積極：技嘉 2 張 + 緯創 3 張 = 95 萬（5 萬備用）
```

---

### 🎯 v4.0 核心改動

#### 改動 1：計分制（vs 現有 13 個 AND）

**現況問題**：
- v3.4 用 13 個條件全部 AND
- 太嚴格 → 常常選不到
- 或選到的都已經噴高了

**解決方案**：改成「門神 + 計分」

#### 改動 2：股價舒適區

```python
# 主力推薦
✅ 股價 100-300 元

# 可選項（標註）
⚠️ 股價 50-100 元（偏低，標註「小型股」）
⚠️ 股價 300-500 元（偏高，標註「高價股」）
```

#### 改動 3：分批策略輸出

```
📊 南亞科 (2408) - 8 分 🔥

【分批買賣策略】
第 1 張：187.5 買 → 195 賣（+4%，保本）
第 2 張：187.5 買 → 200 賣（+7%，主目標）
第 3 張：187.5 買 → 205 賣（+9%，賺更多）

❌ 硬停損：跌破 185（-1.5%）全出

理由：避免「200 一瞬間」來不及賣
```

#### 改動 4：推薦數量控制

```
每日只推 3-6 檔：
🔥 Top 3（≥ 7 分）強烈推薦
✅ Top 4-6（≥ 5 分）推薦買進
👀 觀察清單（≥ 3 分）不輸出（避免太多）
```

---

### 📊 v4.0 評分標準（三方共識）

> 整合：用戶 v2.0 + Gemini 建議 + Claude 短波段版

#### 🚪 門神（硬門檻）不過直接刷掉

```python
# 基本面（揚明光/世紀鋼教訓）
✅ 營業利益率 > 0%      # 本業要賺錢
✅ 毛利率 > 20%          # 有競爭力
✅ PE < 30               # 不買太貴（門檻）

# 流動性
✅ 成交量 > 800 張
✅ 股價 100-300 元       # 舒適區（改）

# 趨勢
✅ 股價 > MA20           # 趨勢向上

# 產業排除
❌ 金融股（28xx, 58xx）
❌ 營建股（25xx, 55xx）
❌ ETF（00xx）
```

#### 🎯 計分系統（滿分 10 分，5 分及格）

##### 【籌碼分】最高 4 分（最重要）
```python
法人連買天數：
  1-3 天 → +3 分   # 南亞科模式（剛進場 🔥）
  4-5 天 → +2 分   # 還可以
  ≥ 6 天 → +1 分   # 緯創模式（可能快出）

法人 5 日買超：
  > 500 張 → +1 分  # 力道強
```

##### 【估值分】最高 1 分
```python
PE < 25 → +1 分    # 世紀鋼教訓（安全區）
```

##### 【動能分】最高 3 分
```python
量能：
  > 5 日均量 1.5 倍 → +2 分   # 爆量啟動
  > 5 日均量 1.2 倍 → +1 分   # 溫和放量

漲幅：
  0-4% → +1 分      # 剛起漲
  > 5% → -1 分      # 已經噴了（扣分）
```

##### 【安全分】最高 1 分
```python
乖離率 < 8% → +1 分   # 離 MA20 近，不追高
```

##### 【題材分】最高 1 分
```python
有明確題材 → +1 分    # CES、0050、併購、財報
```

#### 🎖️ 總分判斷
```
≥ 7 分：🔥 強烈推薦（Top 3）
≥ 5 分：✅ 推薦買進（Top 4-6）
≥ 3 分：👀 列入觀察（不輸出）
< 3 分：❌ 過濾掉
```

---

### 🛠️ 技術實作重點

#### 1. 計分函數（參考 Gemini 的架構）

```python
def calculate_score_v4(stock_data, inst_data, revenue_data):
    """
    v4.0 計分函數

    Returns:
        score: int (0-10)
        reasons: list[str] (評分理由)
        buy_strategy: dict (分批建議)
    """
    score = 0
    reasons = []

    # 籌碼分
    buy_days = count_institutional_buy_days(inst_data)
    if 1 <= buy_days <= 3:
        score += 3
        reasons.append(f"法人剛買{buy_days}天(起漲🔥)")
    elif 4 <= buy_days <= 5:
        score += 2
        reasons.append(f"法人續買{buy_days}天")
    elif buy_days >= 6:
        score += 1
        reasons.append(f"法人買{buy_days}天(小心)")

    # ... 其他評分邏輯

    # 分批策略
    buy_strategy = calculate_batch_strategy(stock_data)

    return score, reasons, buy_strategy
```

#### 2. 分批策略生成

```python
def calculate_batch_strategy(stock_data):
    """
    計算分批買賣建議

    Returns:
        {
            'batch_1': {'price': 195, 'pct': 4, 'note': '保本'},
            'batch_2': {'price': 200, 'pct': 7, 'note': '主目標'},
            'batch_3': {'price': 205, 'pct': 9, 'note': '賺更多'},
            'stop_loss': {'price': 185, 'pct': -1.5}
        }
    """
    current_price = stock_data['price']

    return {
        'batch_1': {
            'price': round(current_price * 1.04, 1),
            'pct': 4,
            'note': '保本先跑'
        },
        'batch_2': {
            'price': round(current_price * 1.07, 1),
            'pct': 7,
            'note': '主要目標'
        },
        'batch_3': {
            'price': round(current_price * 1.10, 1),
            'pct': 10,
            'note': '賺更多'
        },
        'stop_loss': {
            'price': round(current_price * 0.985, 1),
            'pct': -1.5,
            'note': '硬停損'
        }
    }
```

#### 3. 輸出格式（LINE 訊息）

```python
def format_line_message_v4(results):
    """
    格式化 LINE 訊息（v4.0 分批版）

    晚上 20:30 詳細版：
    📊 選股 BOT v4.0 - 2026-01-02

    🔥 南亞科 (2408) - 8 分
      現價：187.5 元
      理由：法人剛買2天、量能爆發、估值安全

      【分批策略】
      第1張：187.5→195（+4%保本）
      第2張：187.5→200（+7%主目標）
      第3張：187.5→205（+10%賺更多）
      ❌停損：185（-1.5%）

    ✅ 緯創 (3231) - 6 分
      ...

    ⚠️ 健康檢查：
      ✅ 所有 API 正常
      📰 相關新聞：[連結]

    ---

    隔天早上 8:30 簡訊版：
    🔔 今日提醒（2026-01-02 08:30）

    🔥 南亞科 187.5
      賣：195/200/205
      停：185

    詳細看昨晚訊息
    """
    pass
```

---

### 📝 待下個 Claude 完成的任務

#### ✅ 必做
1. **改寫 scan_v3.py → scan_v4.py**
   - 加入 `calculate_score_v4()` 函數
   - 加入 `calculate_batch_strategy()` 函數
   - 改寫主程式邏輯（門神 + 計分）
   - 股價範圍改成 100-300 元

2. **修改輸出格式**
   - 只輸出 Top 3-6（≥ 5 分）
   - 加入分批買賣建議
   - 加入健康檢查報告

3. **測試執行**
   - 等明天 TOKEN 重置（約 2026-01-02 01:00）
   - 執行測試確認功能正常

#### 🔄 可選
1. 早上 8:30 簡訊提醒功能
2. LINE 訊息卡片式格式優化
3. 回測功能（驗證評分邏輯）

---

### 🧪 測試案例（用緯創驗證）

```
緯創 (3231) 預期評分：

【門神】
✅ 營業利益率 > 0%（需查）
✅ 毛利率 > 20%（需查）
✅ PE < 30（需查）
✅ 成交量 > 800 張（✅）
✅ 股價 151 元（100-300 ✅）
✅ 股價 > MA20（需算）

【計分】
籌碼：連 8 買 +1 分、5日大買 +1 分 = 2 分
估值：PE 需查（假設 +1）
動能：量能需看、漲幅看開盤
安全：乖離需算
題材：CES +1 分

預估總分：5-7 分 → ✅ 應該會推薦

分批策略：
  151 買 → 157/160/165 賣
  停損：145
```

---

### 💬 用戶偏好提醒

- ❌ **不要自動交易**（人工按單）
- ✅ **分批策略**（避免 200 一瞬間）
- ✅ **3-6 檔推薦**（不要太多）
- ✅ **股價 100-300**（舒適區）
- ✅ **晚上推薦 + 早上提醒**（兩次）
- ✅ **健康檢查**（API 掛了要警告）

---
1/1 23:38追加 需討論

# ---------------------------------------------------
    # 👵 犀利媽 RSI 戰法 (雙線防禦)
    # ---------------------------------------------------
    # 假設你有算出 rsi_5 (5日) 和 rsi_10 (10日)
    # 如果沒有，用通用的 rsi_6 代替 rsi_5 也可以
    
    rsi_short = stock.rsi_5   # 5日線 (極短線)
    rsi_long = stock.rsi_10   # 10日線 (波段線)

    # 1. 【絕對禁區】犀利媽說：RSI在高點多單勿入
    # 這是為了保護你不要當「最後一批犧牲者」
    # 設定：如果 10日RSI 衝過 80，風險太高，直接扣分或淘汰
    if rsi_long > 80:
        score -= 99  # 直接扣到負分，強迫 BOT 不准選它
        reasons.append("👵犀利媽警告:RSI過熱勿追")
        return False, score, reasons # 嚴格一點直接踢掉

    # 2. 【黃金買點】
    # 犀利媽暗示：要在低檔或剛起漲時買
    # 條件：兩條線都在 50~75 之間，且短線 > 長線 (黃金交叉) 為佳
    elif 50 <= rsi_long <= 75 and rsi_short > rsi_long:
        score += 2
        reasons.append(f"RSI多頭排列({rsi_short:.0f}>{rsi_long:.0f})")

    # 3. 【弱勢區】
    # 犀利媽說：低檔準備反彈 (適合技嘉，但不適合緯創)
    # 只有在個位數 (<10) 才是撿便宜，卡在 30-40 叫做「半山腰」
    elif rsi_short < 20:
        score += 1
        reasons.append("RSI超跌(搶反彈要注意)")
    
    # 其他中間地帶 (RSI 40-50)，動能不足，不加分

