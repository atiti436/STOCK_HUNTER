# 選股 BOT v3.0 使用說明

## 功能

找「法人剛進場、體質健康、還沒噴」的股票（抓起漲點，不追高）

## 篩選條件

### 嚴格版（推薦買）

**基本面**
- 價格 50-200 元
- PE < 25
- 毛利率 > 20% (TODO: 財報 API 待修正)
- 營業利益率 > 0% (TODO: 財報 API 待修正)

**技術面 & 籌碼面**
- 今日漲幅 0-5%
- 近 5 日累積漲幅 < 10% (避免追高)
- 法人買超 3-5 天 (剛進場，不是已經買很久)
- 今日量 > 5 日均量 (啟動訊號)

### 寬鬆版（觀察用）

不符合上述某些條件，但會標註原因(如「5日漲12%」、「法人買10天」、「毛利率16%」)

## 使用方式

```bash
cd STOCK_HUNTER
python scan_v3.py
```

執行後會產生 `scan_result_v3.txt`，包含兩份清單：
- [OK] 嚴格版：可直接買
- [!] 寬鬆版：需討論

## 輸出範例

```
[OK] 嚴格版（推薦買）
#  代號   名稱      價格   漲幅    PE  毛利率  營利率  法人      買天  5日漲  量/均
1  1513  中興電   151.0  +2.3%  18.5  25.0%   13.0%   +5,000     4   +3.2%  8000/6500

[!] 寬鬆版（觀察用）
#  代號   名稱      價格   漲幅    PE  法人(張)  疑慮
1  2492  華新科   115.5  +1.2%  23.9   +3,000    5日漲12%, 毛利率16.9%
```

## 已知問題 (2025-12-31 交接)

### 問題 1: FinMind 法人 API 無法抓全部股票

**現象**:
```python
df = dl.taiwan_stock_institutional_investors(stock_id='', ...)
# KeyError: 'data'
```

**原因**:
- 12/31 年底,資料量太大,FinMind API timeout
- `stock_id=''` (空字串抓全部)在法人資料不work

**解決方案**:
1. **方案 A (推薦)**: 改成逐檔抓取
   - 先用基本條件篩選(價格、PE)
   - 針對篩選後的 60 檔,逐一呼叫 `stock_id='2330'`
   - 會慢一點,但穩定

2. **方案 B**: 等非年底再測試
   - 可能只是 12/31 特殊情況

**修改位置**: `scan_v3.py` 第 84-180 行 `fetch_institutional_history()`

---

### 問題 2: 證交所 API 被擋

**現象**: 歷史股價全部失敗 `Expecting value: line 1 column 1`

**原因**:
- 12/31 證交所 API 流量大,容易卡
- 已加 User-Agent header 仍被擋

**解決方案**:
- 改用 FinMind 抓歷史股價 (比證交所穩)
- 或加 retry 機制 + sleep

**修改位置**: `scan_v3.py` 第 43-81 行 `fetch_historical_prices()`

---

### 問題 3: 財報檢查暫時跳過

**現況**: 第 290 行註解掉 `financial_data = {}`

**原因**: 避免測試時 API 錯誤

**TODO**:
- 解決法人 API 後,啟用財報檢查
- 驗證華新科會被排除到寬鬆版(毛利率 16.99%)

---

## 待辦事項

### 立即修正 (優先)
- [ ] **改用逐檔抓取法人資料** (解決 KeyError: 'data')
- [ ] 測試單檔是否正常: `stock_id='2330'`
- [ ] 改成迴圈逐檔抓取

### 次要優化
- [ ] 改用 FinMind 抓歷史股價 (避免證交所被擋)
- [ ] 啟用財報檢查
- [ ] 加快歷史股價抓取速度

### 完整測試 (非年底執行)
- [ ] 在正常交易日(非12/31)測試完整流程
- [ ] 驗證華新科會出現在寬鬆版
- [ ] 確認輸出格式正確

## 版本紀錄

### v3.0 (2025-12-31)
- 新增：近 5 日漲幅檢查(避免追高)
- 新增：法人買超天數檢查(抓起漲點)
- 新增：成交量突破檢查
- 新增：雙清單輸出(嚴格版/寬鬆版)
- 待修：財報檢查(FinMind API 問題)
